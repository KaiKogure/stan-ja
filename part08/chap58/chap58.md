##58. ハミルトンモンテカルロサンプリング

ここではStanで実装されているアルゴリズムの実装の詳細とそれをどのように設定するかを説明します。この章ではハミルトンモンテカルロ(HMC)アルゴリズムとその適応的な変種であるno-U-turn sampler(NUTS)をStanでの実装と構成に基づいて説明します。次の2つの章ではStanの最適化とdiagnostics(診断学)について説明します。

###  58.1 ハミルトンモンテカルロ
ハミルトンモンテカルロ(HMC)とは事後分布間の効率的な遷移を生成するためのサンプリングとして密度関数の導関数を使うようなマルコフ連鎖モンテカルロ法(MCMC)です(より詳細はBetancourt and Girolami, 2013; Neal, 2011)。
この手法はメトロポリス法の受理ステップを行うことで補正された数値積分に基づいて近似されたハミルトン力学系のシミュレーションを用いています。
このセクションはBetancourt and Girolami (2013)によるHMCのプレゼンテーションをGelman et al. (2013)の記法に直したものです。

####目標とする密度関数
サンプリングの最終目的はパラメータθに対する密度p(θ)から値を引くことです。これは与えられたデータyに対するベイズ事後分布p(θ|y)、特にStanプログラムで書かれたベイズ事後分布になります。

####近似運動量変数
HMCでは補助運動量変数ρが導入され、結合密度

![p(Ρ,Θp(p|Θ)p(Θ)NG](1.PNG)

から値が引かれます。Stanを含むHMCのほとんどの応用では補助分布としてはパラメータθに依存しない多変量正規分布

![$$ \rho~MultiNormal(0,\sigma) $$](2.PNG)

を用います。共分散行列Σは目標とする分布の回転とスケール変換のためのユークリッド計量として振舞います(幾何学の詳細についてはBetancourt and Stein, 2011)を参照)。Stanではこの行列はidentity matrix(単位行列)またはwarmup時に推測され、制限された対角行列になります。逆行列Σ^[-1}は質量行列(mass matrix)という名前で知られ、Σが単位、対角、密行列のいずれかであればそれと同じ性質を持ちます。

####ハミルトニアン
結合密度p(ρ,θ)はハミルトニアン

![3.PNG](3.PNG)

で定義され、項T

![4.PNG](4.PNG)

は"運動エネルギー",項V

![5.PNG](5.PNG)

は"ポテンシャルエネルギー"と呼ばれます。このポテンシャルエネルギーはStanでは密度のlogの定義から求まります。

####遷移の生成
現在のパラメータの値θから初めて新しい状態への遷移はメトロポリス法の受理ステップとその前の2つの手順で生成されます。
最初に運動量の値が現在のパラメータの値とは独立に分布

![ρ~MultiNormal(,0Σ)](6.PNG)

から引かれます。運動量は繰り返しのたびに新しい値になり以前の値に影響されません。
次に現在のパラメータの値θと新しい運動量ρを結合したシステム(θ、ρ)ハミルトン方程式に

![7.PNG](7.PNG)

したがって発展させます。
運動量密度と目標の密度関数は独立、つまりp(ρ|θ)=p(ρ)なので運動量の時間微分のはじめの項∂T/∂θ=0になります。よって時間微分の式は

![8.PNG](8.PNG)

となります。
####蛙飛び積分(Leapfrog Integrator)
このセクションの最後に2状態の微分方程式を解く作業が残されています。Stanは他のほとんどのHMCの実装と同様に蛙飛び積分(Leapfrog Integrator)をハミルトン方程式の結果を安定させるための数値積分アルゴリズムとして使っています。
ほとんどの数値積分と同じ様に蛙飛びアルゴリズムは小さな時間間隔εの離散的なステップごとに行われます。蛙飛びアルゴリズムは新しい運動量の項をパラメータθとは独立にひくか前の運動量の値

![9.PNG](9.PNG)

から始め、ステップの半分だけの運動量の更新と1ステップ分の位置の更新を交互に行います。

![10.PNG](10.PNG)

L回の蛙飛びステップでLεだけの時間の動きがシミュレートされます。この結果(上記の3つのステップのL回繰り返し)で得られる状態を(ρ*,θ*)と書きます。
蛙飛び積分の誤差は1ステップあたりεの3乗、大域的にはεの2乗のオーダーになります。
Leimkuhler and Reich(2004)には蛙飛び積分の誤差の範囲の導出を含めたハミルトン系の数値積分の詳細な解析が紹介されています。

####メトロポリス受理ステップ
蛙飛び積分が完全に数値的であれば運動量ベクトルをランダムに生成するのとは別に遷移ごとにランダム化を施す必要はなくなります。しかし実際には積分による数値誤差をメトロポリス受理ステップを適用する際には考慮する必要があります。
(ρ,θ)から生成された提案値(ρ*,θ*)が受理される確率は

![$$ min(1,\exp(H(\rho,\theata)-H(\rho^*,\theata^*))) $$](11.PNG)

であり、もし提案分布が受理されなければ前のパラメータの値が次の値としてサンプルされ、次の繰り返しにも使われます。

####アルゴリズムのまとめ
ハミルトンモンテカルロアルゴリズムは初期設定されたのパラメータの組θからはじめられます。
Stanではこの値はユーザーが設定することもランダムに生成することも出来ます。
そして指定された数だけ新しい運動量のサンプリングと現在のパラメータの値θが時間間隔εで離散化された蛙飛び積分がL回実が繰り替えされることで更新されます
その後メトロポリス受理ステップが適用され提案された状態値(ρ*,θ*)が使われるか元の状態値のままにするかが決定されます。





